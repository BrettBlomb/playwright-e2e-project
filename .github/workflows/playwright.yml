name: Playwright Daily E2E Test

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths-ignore:
      - "README.md"
      - "docs/latest_playwright.mp4"
      - "docs/latest_playwright.gif"
  schedule:
    # Runs every day at 16:00 UTC = 8:00 AM PST
    - cron: "0 16 * * *"

permissions:
  contents: write

jobs:
  playwright-test:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3Ô∏è‚É£ Install dependencies
      - name: Install NPM dependencies
        run: npm install

      # 4Ô∏è‚É£ Fix Playwright binary permissions (CRITICAL FIX)
      - name: Fix Playwright binary permissions
        run: chmod +x ./node_modules/.bin/playwright

      # 5Ô∏è‚É£ Install Playwright system dependencies
      - name: Install Playwright system dependencies
        run: ./node_modules/.bin/playwright install-deps

      # 6Ô∏è‚É£ Install Playwright browsers
      - name: Install Playwright browsers
        run: ./node_modules/.bin/playwright install

      # 7Ô∏è‚É£ Run Playwright tests
      - name: Run Playwright tests
        run: ./node_modules/.bin/playwright test --reporter=html

      # 8Ô∏è‚É£ Install ffmpeg so we can generate GIFs
      - name: Install ffmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      # 9Ô∏è‚É£ Extract newest video and convert to GIF
      - name: Extract Playwright video and generate GIF
        run: |
          mkdir -p docs

          VIDEO=$(find test-results -type f -name "*.webm" -o -name "*.mp4" | head -n 1 || true)

          if [ -z "$VIDEO" ]; then
            echo "No video found, skipping."
            exit 0
          fi

          echo "Found video: $VIDEO"
          cp "$VIDEO" docs/latest_playwright.mp4

          ffmpeg -y -i "$VIDEO" -vf "fps=12,scale=480:-1:flags=lanczos" docs/latest_playwright.gif

      # üîü Update README using template
      - name: Update README
        run: |
          cp ci/readme_template.md README.md

          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          sed -i "s|__TIMESTAMP__|$TIMESTAMP|g" README.md

          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"

          git add README.md docs/latest_playwright.mp4 docs/latest_playwright.gif || echo "Nothing to add"

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update README with latest Playwright login test [skip ci]"
          git push || true

      # 1Ô∏è‚É£1Ô∏è‚É£ Upload Playwright HTML Report
      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
