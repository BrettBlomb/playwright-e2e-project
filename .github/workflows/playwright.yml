name: Playwright Daily E2E Test

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths-ignore:
      - "README.md"
      - "docs/latest_playwright.mp4"
      - "docs/latest_playwright.gif"
      - "docs/*.png"
  schedule:
    # Runs every day at 16:00 UTC (8 AM PST)
    - cron: "0 16 * * *"

permissions:
  contents: write

jobs:
  playwright-test:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3Ô∏è‚É£ Install dependencies
      - name: Install NPM dependencies
        run: npm install

      # 4Ô∏è‚É£ Make Playwright binary executable (CRITICAL FIX)
      - name: Fix Playwright binary permissions
        run: chmod +x ./node_modules/.bin/playwright

      # 5Ô∏è‚É£ Install system dependencies
      - name: Install Playwright system dependencies
        run: ./node_modules/.bin/playwright install-deps

      # 6Ô∏è‚É£ Install browsers Playwright needs
      - name: Install Playwright browsers
        run: ./node_modules/.bin/playwright install

      # 7Ô∏è‚É£ Run tests & generate HTML report
      - name: Run Playwright tests
        run: ./node_modules/.bin/playwright test --reporter=html

      # 8Ô∏è‚É£ Install ffmpeg + gifsicle (GIF combination)
      - name: Install media tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg gifsicle

      # 9Ô∏è‚É£ Extract ALL Playwright videos ‚Üí GIFs ‚Üí combine into one GIF
      - name: Generate combined GIF from all test videos
        run: |
          mkdir -p docs
          mkdir -p temp_gifs

          # Find every Playwright video
          VIDEOS=$(find test-results -type f \( -name "*.webm" -o -name "*.mp4" \) | sort || true)

          if [ -z "$VIDEOS" ]; then
            echo "No videos found. Skipping GIF generation."
            exit 0
          fi

          echo "Videos found:"
          echo "$VIDEOS"

          # Convert each video to a GIF
          index=0
          for VIDEO in $VIDEOS; do
            echo "Converting $VIDEO"
            ffmpeg -y -i "$VIDEO" \
              -vf "fps=12,scale=480:-1:flags=lanczos" \
              temp_gifs/part_$index.gif
            index=$((index+1))
          done

          echo "Combining GIFs..."
          gifsicle --delay=40 --loop temp_gifs/part_*.gif > docs/latest_playwright.gif

          # Save first video for download
          FIRST_VIDEO=$(echo "$VIDEOS" | head -n 1)
          cp "$FIRST_VIDEO" docs/latest_playwright.mp4

      # üîü Update README from template
      - name: Update README
        run: |
          cp ci/readme_template.md README.md

          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          sed -i "s|__TIMESTAMP__|$TIMESTAMP|g" README.md

          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"

          git add README.md docs/latest_playwright.mp4 docs/latest_playwright.gif || echo "Nothing to add"

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update README with latest Playwright combined test video [skip ci]"
          git push || true

      # 1Ô∏è‚É£1Ô∏è‚É£ Upload HTML report for debugging
      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
